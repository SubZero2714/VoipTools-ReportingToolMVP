@page "/test"
@rendermode InteractiveServer

<PageTitle>Test Suite - VoIPTools Reporting</PageTitle>
<link rel="stylesheet" href="testsuite.css" />

<div class="test-suite-container">
    <div class="test-header">
        <h1><span class="oi oi-check"></span> Test Suite</h1>
        <p class="subtitle">Manual testing checklist for VoIPTools Reporting Tool MVP</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: @ProgressPercentage%"></div>
            <span class="progress-text">@CompletedTests / @TotalTests tests passed (@ProgressPercentage%)</span>
        </div>
        <div class="header-actions">
            <button class="btn-action btn-reset" @onclick="ResetAll">
                <span class="oi oi-loop-circular"></span> Reset All
            </button>
            <button class="btn-action btn-expand" @onclick="ExpandAll">
                <span class="oi oi-fullscreen-enter"></span> Expand All
            </button>
            <button class="btn-action btn-collapse" @onclick="CollapseAll">
                <span class="oi oi-fullscreen-exit"></span> Collapse All
            </button>
        </div>
    </div>

    <!-- Phase 0: MVP Features -->
    <div class="test-section @(IsSectionExpanded(Phase0) ? "expanded" : "")">
        <div class="section-header" @onclick="() => ToggleSection(Phase0)">
            <span class="expand-icon oi @(IsSectionExpanded(Phase0) ? "oi-chevron-bottom" : "oi-chevron-right")"></span>
            <h2>Phase 0: MVP Features</h2>
            <span class="section-progress">@GetSectionProgress(Phase0)</span>
        </div>
        <div class="section-content">
            <!-- UI & Layout -->
            <div class="test-group">
                <h3><span class="oi oi-browser"></span> User Interface and Layout</h3>
                @foreach (var test in GetTestsByCategory("UI"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Data Configuration -->
            <div class="test-group">
                <h3><span class="oi oi-cog"></span> Data Configuration and Filtering</h3>
                @foreach (var test in GetTestsByCategory("DataConfig"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Data Grid & Visualization -->
            <div class="test-group">
                <h3><span class="oi oi-graph"></span> Data Grid and Visualization</h3>
                @foreach (var test in GetTestsByCategory("Grid"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Export Functionality -->
            <div class="test-group">
                <h3><span class="oi oi-data-transfer-download"></span> Export Functionality</h3>
                @foreach (var test in GetTestsByCategory("Export"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Info Buttons -->
            <div class="test-group">
                <h3><span class="oi oi-info"></span> Info Buttons and Tooltips</h3>
                @foreach (var test in GetTestsByCategory("Info"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Phase 1: Enhanced Features -->
    <div class="test-section @(IsSectionExpanded(Phase1) ? "expanded" : "")">
        <div class="section-header" @onclick="() => ToggleSection(Phase1)">
            <span class="expand-icon oi @(IsSectionExpanded(Phase1) ? "oi-chevron-bottom" : "oi-chevron-right")"></span>
            <h2>Phase 1: Enhanced Features</h2>
            <span class="section-progress">@GetSectionProgress(Phase1)</span>
        </div>
        <div class="section-content">
            <!-- Date Validation -->
            <div class="test-group">
                <h3><span class="oi oi-calendar"></span> Date Range Validation</h3>
                @foreach (var test in GetTestsByCategory("DateValidation"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Queue Search -->
            <div class="test-group">
                <h3><span class="oi oi-magnifying-glass"></span> Queue Search</h3>
                @foreach (var test in GetTestsByCategory("QueueSearch"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Smart Refresh -->
            <div class="test-group">
                <h3><span class="oi oi-reload"></span> Smart Refresh Button</h3>
                @foreach (var test in GetTestsByCategory("SmartRefresh"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Sidebar Navigation -->
            <div class="test-group">
                <h3><span class="oi oi-menu"></span> Sidebar Navigation</h3>
                @foreach (var test in GetTestsByCategory("Sidebar"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Report Designer -->
            <div class="test-group">
                <h3><span class="oi oi-brush"></span> Report Designer</h3>
                @foreach (var test in GetTestsByCategory("ReportDesigner"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>

            <!-- Report Viewer -->
            <div class="test-group">
                <h3><span class="oi oi-document"></span> Report Viewer</h3>
                @foreach (var test in GetTestsByCategory("ReportViewer"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Performance Tests -->
    <div class="test-section @(IsSectionExpanded(PerfSection) ? "expanded" : "")">
        <div class="section-header" @onclick="() => ToggleSection(PerfSection)">
            <span class="expand-icon oi @(IsSectionExpanded(PerfSection) ? "oi-chevron-bottom" : "oi-chevron-right")"></span>
            <h2>Performance and Reliability</h2>
            <span class="section-progress">@GetSectionProgress(PerfSection)</span>
        </div>
        <div class="section-content">
            <div class="test-group">
                <h3><span class="oi oi-timer"></span> Performance Tests</h3>
                @foreach (var test in GetTestsByCategory("Performance"))
                {
                    <div class="test-item @(test.Passed ? "passed" : "")">
                        <label>
                            <input type="checkbox" checked="@test.Passed" @onchange="() => ToggleTest(test.Id)" />
                            <span class="checkbox-custom"></span>
                            <span class="test-label">@test.Name</span>
                        </label>
                        <span class="test-steps">@test.Steps</span>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    // Constants for section names
    private const string Phase0 = "phase0";
    private const string Phase1 = "phase1";
    private const string PerfSection = "performance";

    private List<TestCase> TestCases = new();
    private HashSet<string> ExpandedSections = new() { Phase0, Phase1 };

    private int TotalTests => TestCases.Count;
    private int CompletedTests => TestCases.Count(t => t.Passed);
    private int ProgressPercentage => TotalTests > 0 ? (int)((double)CompletedTests / TotalTests * 100) : 0;

    protected override void OnInitialized()
    {
        InitializeTestCases();
    }

    private void InitializeTestCases()
    {
        TestCases = new List<TestCase>
        {
            // Phase 0: UI and Layout
            new TestCase { Id = 1, Category = "UI", Phase = Phase0, Name = "Report Builder page loads at /reportbuilder", Steps = "Navigate to /reportbuilder - Page loads without errors" },
            new TestCase { Id = 2, Category = "UI", Phase = Phase0, Name = "Two-column layout displays correctly", Steps = "Left panel has filters, Right panel has results" },
            new TestCase { Id = 3, Category = "UI", Phase = Phase0, Name = "Platform theme applied (blue sidebar, white content)", Steps = "Verify blue gradient sidebar, white main area" },
            new TestCase { Id = 4, Category = "UI", Phase = Phase0, Name = "All DevExpress components render", Steps = "Check DxDateEdit, DxListBox, DxComboBox, DxButton render correctly" },

            // Phase 0: Data Configuration
            new TestCase { Id = 10, Category = "DataConfig", Phase = Phase0, Name = "Date pickers accept date input", Steps = "Click date picker - Select date - Date displays in dd-MM-yyyy format" },
            new TestCase { Id = 11, Category = "DataConfig", Phase = Phase0, Name = "Queue list loads from database", Steps = "Verify queue list shows 31 queues (8000, 8001, etc.)" },
            new TestCase { Id = 12, Category = "DataConfig", Phase = Phase0, Name = "Multiple queues can be selected", Steps = "Check multiple queue checkboxes - All show selected" },
            new TestCase { Id = 13, Category = "DataConfig", Phase = Phase0, Name = "Select All/Clear buttons work for queues", Steps = "Click Select All - All queues checked. Click Clear - All unchecked" },
            new TestCase { Id = 14, Category = "DataConfig", Phase = Phase0, Name = "Column list loads correctly", Steps = "Verify columns: QueueNumber, TotalCalls, PolledCount, etc." },
            new TestCase { Id = 15, Category = "DataConfig", Phase = Phase0, Name = "Multiple columns can be selected", Steps = "Check multiple column checkboxes - All show selected" },
            new TestCase { Id = 16, Category = "DataConfig", Phase = Phase0, Name = "Chart type dropdown works", Steps = "Select Bar, Line, Pie from dropdown - Value changes" },

            // Phase 0: Grid and Visualization
            new TestCase { Id = 20, Category = "Grid", Phase = Phase0, Name = "Data grid populates after Refresh", Steps = "Select dates, queues, columns - Click Refresh - Grid shows data" },
            new TestCase { Id = 21, Category = "Grid", Phase = Phase0, Name = "Grid columns match selected columns", Steps = "Select specific columns - Only those columns appear in grid" },
            new TestCase { Id = 22, Category = "Grid", Phase = Phase0, Name = "Grid supports filtering", Steps = "Type in filter row below headers - Data filters" },
            new TestCase { Id = 23, Category = "Grid", Phase = Phase0, Name = "Grid supports grouping", Steps = "Drag column header to group panel - Data groups" },
            new TestCase { Id = 24, Category = "Grid", Phase = Phase0, Name = "Grid pagination works", Steps = "Load 50+ rows - Use page buttons at bottom" },
            new TestCase { Id = 25, Category = "Grid", Phase = Phase0, Name = "Bar chart displays correctly", Steps = "Select Bar chart, X/Y fields - Bar chart renders" },
            new TestCase { Id = 26, Category = "Grid", Phase = Phase0, Name = "Line chart displays correctly", Steps = "Select Line chart, X/Y fields - Line chart renders" },
            new TestCase { Id = 27, Category = "Grid", Phase = Phase0, Name = "Pie chart displays correctly", Steps = "Select Pie chart, X/Y fields - Pie chart renders with labels" },

            // Phase 0: Export
            new TestCase { Id = 30, Category = "Export", Phase = Phase0, Name = "Excel export downloads .xlsx file", Steps = "Click Excel button - File downloads - Opens in Excel" },
            new TestCase { Id = 31, Category = "Export", Phase = Phase0, Name = "Excel file has correct data", Steps = "Open exported Excel - Data matches grid" },
            new TestCase { Id = 32, Category = "Export", Phase = Phase0, Name = "CSV export downloads .csv file", Steps = "Click CSV button - File downloads - Opens in Notepad/Excel" },
            new TestCase { Id = 33, Category = "Export", Phase = Phase0, Name = "CSV file has correct data", Steps = "Open exported CSV - Data matches grid" },
            new TestCase { Id = 34, Category = "Export", Phase = Phase0, Name = "PDF export downloads .pdf file", Steps = "Click PDF button - File downloads - Opens in PDF viewer" },
            new TestCase { Id = 35, Category = "Export", Phase = Phase0, Name = "PDF has formatted table with headers", Steps = "Open PDF - Blue header, alternating rows, page numbers" },

            // Phase 0: Info Buttons
            new TestCase { Id = 40, Category = "Info", Phase = Phase0, Name = "Date Range info button shows tooltip", Steps = "Click info on Date Range - Tooltip with instructions appears" },
            new TestCase { Id = 41, Category = "Info", Phase = Phase0, Name = "Queues info button shows tooltip", Steps = "Click info on Queues - Tooltip with instructions appears" },
            new TestCase { Id = 42, Category = "Info", Phase = Phase0, Name = "Columns info button shows tooltip", Steps = "Click info on Columns - Tooltip with column descriptions" },
            new TestCase { Id = 43, Category = "Info", Phase = Phase0, Name = "Chart info button shows tooltip", Steps = "Click info on Chart - Tooltip with chart setup guide" },
            new TestCase { Id = 44, Category = "Info", Phase = Phase0, Name = "Export info button shows tooltip", Steps = "Click info on Export - Tooltip with format descriptions" },
            new TestCase { Id = 45, Category = "Info", Phase = Phase0, Name = "Only one tooltip open at a time", Steps = "Click info A - Click info B - Only B visible" },
            new TestCase { Id = 46, Category = "Info", Phase = Phase0, Name = "Tooltip close button works", Steps = "Click info - Click X button - Tooltip closes" },

            // Phase 1: Date Validation
            new TestCase { Id = 50, Category = "DateValidation", Phase = Phase1, Name = "Error shows when From > To date", Steps = "Set From=Dec 25, Set To=Dec 1 - Red error message appears" },
            new TestCase { Id = 51, Category = "DateValidation", Phase = Phase1, Name = "Error shows for date range > 365 days", Steps = "Set range > 1 year - Error cannot exceed 365 days" },
            new TestCase { Id = 52, Category = "DateValidation", Phase = Phase1, Name = "Date inputs show red border on error", Steps = "Create validation error - Date boxes have red border" },
            new TestCase { Id = 53, Category = "DateValidation", Phase = Phase1, Name = "Error clears when dates are valid", Steps = "Fix the date range - Error message disappears" },

            // Phase 1: Queue Search
            new TestCase { Id = 60, Category = "QueueSearch", Phase = Phase1, Name = "Search box appears above queue list", Steps = "Verify search box with magnifying glass placeholder" },
            new TestCase { Id = 61, Category = "QueueSearch", Phase = Phase1, Name = "Typing filters queue list", Steps = "Type 8001 - Only matching queues shown" },
            new TestCase { Id = 62, Category = "QueueSearch", Phase = Phase1, Name = "Search works by queue name", Steps = "Type Queue 80 - Matching queues filter" },
            new TestCase { Id = 63, Category = "QueueSearch", Phase = Phase1, Name = "Clear search shows all queues", Steps = "Clear search text - All 31 queues visible" },

            // Phase 1: Smart Refresh
            new TestCase { Id = 70, Category = "SmartRefresh", Phase = Phase1, Name = "Button disabled with invalid dates", Steps = "Create date error - Refresh button is disabled" },
            new TestCase { Id = 71, Category = "SmartRefresh", Phase = Phase1, Name = "Button disabled with no queues", Steps = "Clear all queues - Button disabled + hint shown" },
            new TestCase { Id = 72, Category = "SmartRefresh", Phase = Phase1, Name = "Button disabled with no columns", Steps = "Clear all columns - Button disabled + hint shown" },
            new TestCase { Id = 73, Category = "SmartRefresh", Phase = Phase1, Name = "Hint shows specific missing requirement", Steps = "Verify hint text matches what is missing" },
            new TestCase { Id = 74, Category = "SmartRefresh", Phase = Phase1, Name = "Button enabled when all valid", Steps = "Select dates + queues + columns - Button enabled" },

            // Phase 1: Sidebar
            new TestCase { Id = 80, Category = "Sidebar", Phase = Phase1, Name = "Collapse button visible in sidebar", Steps = "Verify chevron button in sidebar header" },
            new TestCase { Id = 81, Category = "Sidebar", Phase = Phase1, Name = "Clicking collapse hides text", Steps = "Click collapse - Only icons visible, text hidden" },
            new TestCase { Id = 82, Category = "Sidebar", Phase = Phase1, Name = "Sidebar expands on second click", Steps = "Click expand - Full sidebar with text returns" },
            new TestCase { Id = 83, Category = "Sidebar", Phase = Phase1, Name = "Nav links work in collapsed mode", Steps = "With sidebar collapsed - Click icons - Pages navigate" },
            new TestCase { Id = 84, Category = "Sidebar", Phase = Phase1, Name = "Active page highlighted", Steps = "On Report Builder - That nav item is highlighted" },

            // Phase 1: Report Designer
            new TestCase { Id = 100, Category = "ReportDesigner", Phase = Phase1, Name = "Report Designer page loads at /reportdesigner", Steps = "Navigate to /reportdesigner - Page loads with designer UI" },
            new TestCase { Id = 101, Category = "ReportDesigner", Phase = Phase1, Name = "Designer toolbar displays correctly", Steps = "Verify toolbar with New, Open, Save, Preview buttons" },
            new TestCase { Id = 102, Category = "ReportDesigner", Phase = Phase1, Name = "Toolbox panel shows report elements", Steps = "Left panel shows Labels, Tables, Images, etc." },
            new TestCase { Id = 103, Category = "ReportDesigner", Phase = Phase1, Name = "Property grid shows on element select", Steps = "Click element in designer - Properties panel updates" },
            new TestCase { Id = 104, Category = "ReportDesigner", Phase = Phase1, Name = "Can drag elements to design surface", Steps = "Drag Label from toolbox to report - Element placed" },
            new TestCase { Id = 105, Category = "ReportDesigner", Phase = Phase1, Name = "Can save report to file", Steps = "Create report - Click Save - Enter name - Report saved" },
            new TestCase { Id = 106, Category = "ReportDesigner", Phase = Phase1, Name = "Can open existing report", Steps = "Click Open - Select report - Report loads in designer" },

            // Phase 1: Report Viewer
            new TestCase { Id = 110, Category = "ReportViewer", Phase = Phase1, Name = "Report Viewer page loads at /reportviewer", Steps = "Navigate to /reportviewer - Page loads with viewer UI" },
            new TestCase { Id = 111, Category = "ReportViewer", Phase = Phase1, Name = "Report dropdown lists available reports", Steps = "Click dropdown - Shows list of saved reports" },
            new TestCase { Id = 112, Category = "ReportViewer", Phase = Phase1, Name = "Selected report renders in viewer", Steps = "Select report from list - Report displays in viewer" },
            new TestCase { Id = 113, Category = "ReportViewer", Phase = Phase1, Name = "Viewer toolbar has export options", Steps = "Verify toolbar with PDF, Excel, Print buttons" },
            new TestCase { Id = 114, Category = "ReportViewer", Phase = Phase1, Name = "Can print report from viewer", Steps = "Click Print - Print dialog opens" },
            new TestCase { Id = 115, Category = "ReportViewer", Phase = Phase1, Name = "Can export report to PDF", Steps = "Click PDF export - File downloads as PDF" },

            // Performance
            new TestCase { Id = 90, Category = "Performance", Phase = PerfSection, Name = "Query completes in < 5 seconds", Steps = "Load 1000+ rows - Check query time in console/logs" },
            new TestCase { Id = 91, Category = "Performance", Phase = PerfSection, Name = "Grid renders smoothly", Steps = "Load data - No visible lag when scrolling" },
            new TestCase { Id = 92, Category = "Performance", Phase = PerfSection, Name = "Chart renders in < 1 second", Steps = "Change chart type - Chart appears quickly" },
            new TestCase { Id = 93, Category = "Performance", Phase = PerfSection, Name = "Export completes without timeout", Steps = "Export 1000+ rows - File downloads completely" },
            new TestCase { Id = 94, Category = "Performance", Phase = PerfSection, Name = "No console errors (F12)", Steps = "Open DevTools Console - No red error messages" },
        };
    }

    private IEnumerable<TestCase> GetTestsByCategory(string category)
    {
        return TestCases.Where(t => t.Category == category);
    }

    private void ToggleTest(int id)
    {
        var test = TestCases.FirstOrDefault(t => t.Id == id);
        if (test != null)
        {
            test.Passed = !test.Passed;
        }
    }

    private void ToggleSection(string section)
    {
        if (ExpandedSections.Contains(section))
            ExpandedSections.Remove(section);
        else
            ExpandedSections.Add(section);
    }

    private bool IsSectionExpanded(string section) => ExpandedSections.Contains(section);

    private string GetSectionProgress(string phase)
    {
        var phaseTests = TestCases.Where(t => t.Phase == phase);
        var passed = phaseTests.Count(t => t.Passed);
        var total = phaseTests.Count();
        return $"{passed}/{total}";
    }

    private void ResetAll()
    {
        foreach (var test in TestCases)
        {
            test.Passed = false;
        }
    }

    private void ExpandAll()
    {
        ExpandedSections = new HashSet<string> { Phase0, Phase1, PerfSection };
    }

    private void CollapseAll()
    {
        ExpandedSections.Clear();
    }

    private class TestCase
    {
        public int Id { get; set; }
        public string Category { get; set; } = "";
        public string Phase { get; set; } = "";
        public string Name { get; set; } = "";
        public string Steps { get; set; } = "";
        public bool Passed { get; set; }
    }
}
