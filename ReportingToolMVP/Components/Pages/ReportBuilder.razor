@page "/reportbuilder"
@using ReportingToolMVP.Models
@using ReportingToolMVP.Services
@using DevExpress.Blazor
@using System.Dynamic
@rendermode InteractiveServer

@inject ICustomReportService ReportService
@inject IReportExportService ExportService
@inject ILogger<ReportBuilder> Logger
@inject IJSRuntime JS

<PageTitle>Report Builder - VoIPTools</PageTitle>

<link href="reportbuilder.css" rel="stylesheet" />

<div class="report-builder-container">
    <!-- LEFT SIDEBAR: Filters & Configuration -->
    <div class="config-panel">
        <!-- Date Range Card -->
        <div class="config-card">
            <div class="card-header-row">
                <h5><span class="oi oi-calendar"></span> DATE RANGE</h5>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.DateRange)" title="Date Range Info">‚ÑπÔ∏è</button>
            </div>
            @if (ActiveInfo == InfoType.DateRange)
            {
                <div class="info-tooltip">
                    <strong>üìÖ Date Range Filter</strong><br/><br/>
                    <strong>What it does:</strong> Filters call data by date period.<br/><br/>
                    <strong>How to use:</strong><br/>
                    <span class="step">1.</span> Click the "From Date" field and select start date<br/>
                    <span class="step">2.</span> Click the "To Date" field and select end date<br/>
                    <span class="step">3.</span> Only calls within this range will appear<br/><br/>
                    <em>üí° Tip: Current data available from Dec 2023 to Oct 2025</em>
                    <button class="close-info" @onclick="CloseInfo">√ó</button>
                </div>
            }
            <div class="form-group">
                <label>From Date:</label>
                <DxDateEdit @bind-Date="@Config.StartDate" 
                            @bind-Date:after="OnDateRangeChanged"
                            Format="dd-MM-yyyy"
                            CssClass="@GetDateInputClass(true)"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Never" />
            </div>
            <div class="form-group">
                <label>To Date:</label>
                <DxDateEdit @bind-Date="@Config.EndDate" 
                            @bind-Date:after="OnDateRangeChanged"
                            Format="dd-MM-yyyy"
                            CssClass="@GetDateInputClass(false)"
                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Never" />
            </div>
            @if (!string.IsNullOrEmpty(DateValidationError))
            {
                <div class="validation-error">
                    <span class="oi oi-warning"></span> @DateValidationError
                </div>
            }
        </div>

        <!-- Queues Card -->
        <div class="config-card">
            <div class="card-header-row">
                <h5><span class="oi oi-people"></span> QUEUES</h5>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Queues)" title="Queues Info">‚ÑπÔ∏è</button>
            </div>
            @if (ActiveInfo == InfoType.Queues)
            {
                <div class="info-tooltip">
                    <strong>üìû Queue Selection</strong><br/><br/>
                    <strong>What it does:</strong> Filters data by call queue numbers.<br/><br/>
                    <strong>How to use:</strong><br/>
                    <span class="step">1.</span> Use search box to filter queues<br/>
                    <span class="step">2.</span> Click checkbox ‚òëÔ∏è next to each queue to select<br/>
                    <span class="step">3.</span> Use "Select All" to include all queues<br/>
                    <span class="step">4.</span> Use "Clear" to deselect all queues<br/><br/>
                    <em>üí° Tip: Select multiple queues to compare their performance</em>
                    <button class="close-info" @onclick="CloseInfo">√ó</button>
                </div>
            }
            <DxTextBox Text="@QueueSearchText"
                       TextChanged="@OnQueueSearchChanged"
                       NullText="üîç Search queues..."
                       CssClass="queue-search-box" />
            <DxListBox Data="@FilteredQueues"
                       @bind-Values="@SelectedQueues"
                       TextFieldName="QueueName"
                       ValueFieldName="QueueId"
                       SelectionMode="ListBoxSelectionMode.Multiple"
                       ShowCheckboxes="true"
                       CssClass="dx-listbox-queues" />
            <div class="button-row mt-2">
                <DxButton Text="Select All" 
                          Click="@SelectAllQueues" 
                          RenderStyle="ButtonRenderStyle.Secondary"
                          SizeMode="SizeMode.Small" />
                <DxButton Text="Clear" 
                          Click="@ClearQueues" 
                          RenderStyle="ButtonRenderStyle.Light"
                          SizeMode="SizeMode.Small" />
            </div>
        </div>

        <!-- Columns Card -->
        <div class="config-card">
            <div class="card-header-row">
                <h5><span class="oi oi-list"></span> COLUMNS</h5>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Columns)" title="Columns Info">‚ÑπÔ∏è</button>
            </div>
            @if (ActiveInfo == InfoType.Columns)
            {
                <div class="info-tooltip">
                    <strong>üìã Column Selection</strong><br/><br/>
                    <strong>What it does:</strong> Choose which data fields appear in your report.<br/><br/>
                    <strong>Available columns:</strong><br/>
                    ‚Ä¢ <strong>TotalCalls</strong> - Number of calls received<br/>
                    ‚Ä¢ <strong>DialedCount</strong> - Outbound calls made<br/>
                    ‚Ä¢ <strong>AvgWaitTime</strong> - Average caller wait time (seconds)<br/>
                    ‚Ä¢ <strong>AvgServiceTime</strong> - Average call duration<br/>
                    ‚Ä¢ <strong>Date</strong> - Call date for grouping<br/><br/>
                    <strong>How to use:</strong><br/>
                    <span class="step">1.</span> Click checkbox ‚òëÔ∏è to select columns<br/>
                    <span class="step">2.</span> Columns appear in selection order<br/>
                    <span class="step">3.</span> At least one column is required<br/><br/>
                    <em>üí° Tip: Select "Date" + metrics for time-based analysis</em>
                    <button class="close-info" @onclick="CloseInfo">√ó</button>
                </div>
            }
            <DxListBox Data="@AvailableColumns"
                       @bind-Values="@SelectedColumns"
                       SelectionMode="ListBoxSelectionMode.Multiple"
                       ShowCheckboxes="true"
                       CssClass="dx-listbox-columns" />
            <div class="button-row mt-2">
                <DxButton Text="Select All" 
                          Click="@SelectAllColumns" 
                          RenderStyle="ButtonRenderStyle.Secondary"
                          SizeMode="SizeMode.Small" />
                <DxButton Text="Clear" 
                          Click="@ClearColumns" 
                          RenderStyle="ButtonRenderStyle.Light"
                          SizeMode="SizeMode.Small" />
            </div>
        </div>

        <!-- Chart Configuration Card -->
        <div class="config-card">
            <div class="card-header-row">
                <h5><span class="oi oi-graph"></span> CHART CONFIGURATION</h5>
                <button class="info-btn" @onclick="() => ShowInfo(InfoType.Chart)" title="Chart Info">‚ÑπÔ∏è</button>
            </div>
            @if (ActiveInfo == InfoType.Chart)
            {
                <div class="info-tooltip">
                    <strong>üìä Chart Configuration</strong><br/><br/>
                    <strong>What it does:</strong> Creates visual charts from your data.<br/><br/>
                    <strong>Chart Types:</strong><br/>
                    ‚Ä¢ <strong>Bar</strong> - Compare values across categories<br/>
                    ‚Ä¢ <strong>Line</strong> - Show trends over time<br/>
                    ‚Ä¢ <strong>Pie</strong> - Show proportions of a whole<br/>
                    ‚Ä¢ <strong>None</strong> - No chart, data grid only<br/><br/>
                    <strong>How to use:</strong><br/>
                    <span class="step">1.</span> Select a Chart Type from dropdown<br/>
                    <span class="step">2.</span> Choose X-Axis (categories, e.g., Date)<br/>
                    <span class="step">3.</span> Choose Y-Axis (values, e.g., TotalCalls)<br/>
                    <span class="step">4.</span> Click "Refresh Report" to generate<br/><br/>
                    <em>üí° Tip: Use Date as X-Axis and TotalCalls as Y-Axis for trends</em>
                    <button class="close-info" @onclick="CloseInfo">√ó</button>
                </div>
            }
            <div class="form-group">
                <label>Chart Type:</label>
                <DxComboBox Data="@ChartTypes"
                            @bind-Value="@Config.ChartType"
                            CssClass="dx-combo-chart" />
            </div>
            @if (Config.ChartType != "None")
            {
                <div class="form-group">
                    <label>X-Axis:</label>
                    <DxComboBox Data="@SelectedColumnsList"
                                @bind-Value="@Config.ChartXField"
                                NullText="-- Select --"
                                CssClass="dx-combo-chart" />
                </div>
                <div class="form-group">
                    <label>Y-Axis:</label>
                    <DxComboBox Data="@SelectedColumnsList"
                                @bind-Value="@Config.ChartYField"
                                NullText="-- Select --"
                                CssClass="dx-combo-chart" />
                </div>
            }
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <DxButton Text="@(IsLoading ? "Loading..." : "Refresh Report")"
                      Click="@RefreshReport"
                      RenderStyle="ButtonRenderStyle.Primary"
                      CssClass="w-100"
                      IconCssClass="@(IsLoading ? "" : "oi oi-reload")"
                      Enabled="@(!IsLoading && IsRefreshEnabled)" />
            @if (!IsRefreshEnabled && !IsLoading)
            {
                <div class="refresh-hint">
                    @if (!string.IsNullOrEmpty(DateValidationError))
                    {
                        <span>‚ö†Ô∏è Fix date range errors</span>
                    }
                    else if (!SelectedQueues.Any())
                    {
                        <span>üìã Select at least one queue</span>
                    }
                    else if (!SelectedColumns.Any())
                    {
                        <span>üìã Select at least one column</span>
                    }
                </div>
            }
            <DxButton Text="Clear All" 
                      Click="@ClearAll" 
                      RenderStyle="ButtonRenderStyle.Light"
                      CssClass="w-100 mt-2" />
        </div>
    </div>

    <!-- RIGHT PANEL: Results -->
    <div class="results-panel">
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger">
                <span class="oi oi-warning"></span> @ErrorMessage
            </div>
        }

        @if (ReportData == null || !ReportData.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <h4>No data to display</h4>
                <p>Configure filters and click "Refresh Report" to load data.</p>
            </div>
        }
        else
        {
            <!-- Header with Export Buttons -->
            <div class="results-header">
                <div class="results-title-row">
                    <h4>Report Preview <span class="badge">@ReportData.Count rows</span></h4>
                    <button class="info-btn" @onclick="() => ShowInfo(InfoType.Results)" title="Results Info">‚ÑπÔ∏è</button>
                </div>
                @if (ActiveInfo == InfoType.Results)
                {
                    <div class="info-tooltip info-tooltip-right">
                        <strong>üìà Report Results Grid</strong><br/><br/>
                        <strong>What it shows:</strong> Your filtered call data in a table format.<br/><br/>
                        <strong>Grid Features:</strong><br/>
                        ‚Ä¢ <strong>Sort:</strong> Click column headers to sort A-Z or Z-A<br/>
                        ‚Ä¢ <strong>Filter:</strong> Use filter row below headers to search<br/>
                        ‚Ä¢ <strong>Group:</strong> Drag column header to gray bar above<br/>
                        ‚Ä¢ <strong>Resize:</strong> Drag column borders to adjust width<br/>
                        ‚Ä¢ <strong>Pages:</strong> Navigate pages at the bottom<br/><br/>
                        <strong>How to use:</strong><br/>
                        <span class="step">1.</span> Review your data in the grid<br/>
                        <span class="step">2.</span> Click Export buttons to download<br/>
                        <span class="step">3.</span> Adjust filters and refresh for new data<br/><br/>
                        <em>üí° Tip: Double-click column border to auto-fit width</em>
                        <button class="close-info" @onclick="CloseInfo">√ó</button>
                    </div>
                }
                <div class="export-buttons">
                    <button class="info-btn me-2" @onclick="() => ShowInfo(InfoType.Export)" title="Export Info">‚ÑπÔ∏è</button>
                    @if (ActiveInfo == InfoType.Export)
                    {
                        <div class="info-tooltip info-tooltip-export">
                            <strong>üì§ Export Options</strong><br/><br/>
                            <strong>Available Formats:</strong><br/><br/>
                            <strong>üìó Excel (.xlsx)</strong><br/>
                            ‚Ä¢ Full formatting with headers<br/>
                            ‚Ä¢ Opens in Microsoft Excel<br/>
                            ‚Ä¢ Best for further analysis<br/><br/>
                            <strong>üìÑ CSV (.csv)</strong><br/>
                            ‚Ä¢ Plain text, comma-separated<br/>
                            ‚Ä¢ Opens in any spreadsheet app<br/>
                            ‚Ä¢ Best for importing to other systems<br/><br/>
                            <strong>üìï PDF (.pdf)</strong><br/>
                            ‚Ä¢ Professional formatted document<br/>
                            ‚Ä¢ Ready to print or share<br/>
                            ‚Ä¢ Best for reports and presentations<br/><br/>
                            <em>üí° Tip: Click button to download immediately</em>
                            <button class="close-info" @onclick="CloseInfo">√ó</button>
                        </div>
                    }
                    <DxButton Text="Excel"
                              Click="@(async () => await ExportReport("Excel"))"
                              RenderStyle="ButtonRenderStyle.Success"
                              SizeMode="SizeMode.Small"
                              IconCssClass="oi oi-spreadsheet"
                              Enabled="@(!IsExporting)" />
                    <DxButton Text="CSV"
                              Click="@(async () => await ExportReport("CSV"))"
                              RenderStyle="ButtonRenderStyle.Info"
                              SizeMode="SizeMode.Small"
                              IconCssClass="oi oi-document"
                              Enabled="@(!IsExporting)" />
                    <DxButton Text="PDF"
                              Click="@(async () => await ExportReport("PDF"))"
                              RenderStyle="ButtonRenderStyle.Warning"
                              SizeMode="SizeMode.Small"
                              IconCssClass="oi oi-file"
                              Enabled="@(!IsExporting)" />
                </div>
            </div>

            <!-- DevExpress Data Grid -->
            <DxGrid Data="@ReportData"
                    ShowFilterRow="true"
                    ShowGroupPanel="true"
                    ColumnResizeMode="GridColumnResizeMode.NextColumn"
                    CssClass="report-grid"
                    PageSize="50"
                    PagerVisible="true"
                    PagerNavigationMode="PagerNavigationMode.NumericButtons">
                <Columns>
                    @foreach (var col in SelectedColumnsList)
                    {
                        <DxGridDataColumn FieldName="@col" Caption="@FormatColumnName(col)" />
                    }
                </Columns>
            </DxGrid>

            <!-- Chart Area -->
            @if (Config.ChartType != "None" && !string.IsNullOrEmpty(Config.ChartXField) && !string.IsNullOrEmpty(Config.ChartYField))
            {
                <div class="chart-section">
                    <h5>@Config.ChartType Chart: @Config.ChartYField by @Config.ChartXField</h5>
                    @if (Config.ChartType == "Bar")
                    {
                        <DxChart Data="@GetChartData()" CssClass="report-chart" T="ChartDataPoint">
                            <DxChartBarSeries T="ChartDataPoint"
                                              TArgument="string"
                                              TValue="decimal"
                                              ArgumentField="x => x.Argument"
                                              ValueField="x => x.Value"
                                              Name="@Config.ChartYField" />
                            <DxChartLegend Visible="true" Position="RelativePosition.Outside" />
                        </DxChart>
                    }
                    else if (Config.ChartType == "Line")
                    {
                        <DxChart Data="@GetChartData()" CssClass="report-chart" T="ChartDataPoint">
                            <DxChartLineSeries T="ChartDataPoint"
                                               TArgument="string"
                                               TValue="decimal"
                                               ArgumentField="x => x.Argument"
                                               ValueField="x => x.Value"
                                               Name="@Config.ChartYField" />
                            <DxChartLegend Visible="true" Position="RelativePosition.Outside" />
                        </DxChart>
                    }
                    else if (Config.ChartType == "Pie")
                    {
                        <DxPieChart Data="@GetChartData()" CssClass="report-chart" T="ChartDataPoint">
                            <DxPieChartSeries T="ChartDataPoint"
                                              TArgument="string"
                                              TValue="decimal"
                                              ArgumentField="x => x.Argument"
                                              ValueField="x => x.Value"
                                              Name="@Config.ChartYField">
                                <DxChartSeriesLabel Visible="true" Position="RelativePosition.Outside" />
                            </DxPieChartSeries>
                            <DxChartLegend Visible="true" Position="RelativePosition.Outside" />
                        </DxPieChart>
                    }
                </div>
            }
        }
    </div>
</div>

@code {
    private ReportConfig Config = new();
    private List<QueueBasicInfo> AvailableQueues = new();
    private List<string> AvailableColumns = new();
    private List<string> ChartTypes = new() { "None", "Bar", "Line", "Pie" };
    private List<Dictionary<string, object>>? RawReportData = null;
    private List<ExpandoObject>? ReportData = null;

    // DevExpress ListBox bindings
    private IEnumerable<string> SelectedQueues { get; set; } = Enumerable.Empty<string>();
    private IEnumerable<string> SelectedColumns { get; set; } = Enumerable.Empty<string>();

    // Helper to convert selected columns to list for chart combo
    private List<string> SelectedColumnsList => SelectedColumns.ToList();

    private bool IsLoading = false;
    private bool IsExporting = false;
    private string ErrorMessage = string.Empty;

    // Date validation
    private string DateValidationError = string.Empty;
    private const int MaxDateRangeDays = 365; // Maximum 1 year range

    // Queue search
    private string QueueSearchText = string.Empty;
    private List<QueueBasicInfo> FilteredQueues => string.IsNullOrWhiteSpace(QueueSearchText)
        ? AvailableQueues
        : AvailableQueues.Where(q => 
            q.QueueName.Contains(QueueSearchText, StringComparison.OrdinalIgnoreCase) ||
            q.QueueId.Contains(QueueSearchText, StringComparison.OrdinalIgnoreCase)).ToList();

    // Info button functionality
    private enum InfoType { None, DateRange, Queues, Columns, Chart, Results, Export }
    private InfoType ActiveInfo = InfoType.None;

    private void ShowInfo(InfoType infoType)
    {
        ActiveInfo = ActiveInfo == infoType ? InfoType.None : infoType;
    }

    private void CloseInfo()
    {
        ActiveInfo = InfoType.None;
    }

    private void OnQueueSearchChanged(string searchText)
    {
        QueueSearchText = searchText ?? string.Empty;
    }

    private void OnDateRangeChanged()
    {
        ValidateDateRange();
    }

    private bool ValidateDateRange()
    {
        DateValidationError = string.Empty;

        if (!Config.StartDate.HasValue || !Config.EndDate.HasValue)
        {
            DateValidationError = "Both From and To dates are required.";
            return false;
        }

        if (Config.StartDate.Value > Config.EndDate.Value)
        {
            DateValidationError = "From date cannot be after To date.";
            return false;
        }

        var daysDiff = (Config.EndDate.Value - Config.StartDate.Value).Days;
        if (daysDiff > MaxDateRangeDays)
        {
            DateValidationError = $"Date range cannot exceed {MaxDateRangeDays} days (1 year).";
            return false;
        }

        return true;
    }

    private string GetDateInputClass(bool isStartDate)
    {
        if (string.IsNullOrEmpty(DateValidationError))
            return "dx-date-input";
        
        // Add error class if there's a validation error
        return "dx-date-input date-input-error";
    }

    private bool IsRefreshEnabled => string.IsNullOrEmpty(DateValidationError) && 
                                     SelectedQueues.Any() && 
                                     SelectedColumns.Any();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            AvailableQueues = await ReportService.GetQueuesAsync();
            AvailableColumns = await ReportService.GetAvailableColumnsAsync();
            // Use dates with actual data - database has records from Dec 2023 to Oct 2025
            Config.EndDate = new DateTime(2025, 10, 29);
            Config.StartDate = new DateTime(2025, 10, 1);
            ValidateDateRange(); // Validate initial dates
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading initial data");
            ErrorMessage = "Failed to load queues and columns. Please refresh the page.";
        }
    }

    private void SelectAllQueues()
    {
        SelectedQueues = AvailableQueues.Select(q => q.QueueId).ToList();
    }

    private void ClearQueues()
    {
        SelectedQueues = Enumerable.Empty<string>();
    }

    private void SelectAllColumns()
    {
        SelectedColumns = AvailableColumns.ToList();
    }

    private void ClearColumns()
    {
        SelectedColumns = Enumerable.Empty<string>();
    }

    private void ClearAll()
    {
        ClearQueues();
        ClearColumns();
        QueueSearchText = string.Empty;
        RawReportData = null;
        ReportData = null;
        ErrorMessage = string.Empty;
        DateValidationError = string.Empty;
        Config.ChartType = "None";
        Config.ChartXField = string.Empty;
        Config.ChartYField = string.Empty;
        // Reset dates to defaults
        Config.EndDate = new DateTime(2025, 10, 29);
        Config.StartDate = new DateTime(2025, 10, 1);
        ValidateDateRange();
    }

    private string FormatColumnName(string columnName)
    {
        // Convert camelCase/PascalCase to readable format
        return System.Text.RegularExpressions.Regex.Replace(columnName, "(\\B[A-Z])", " $1");
    }

    // Chart data model
    public class ChartDataPoint
    {
        public string Argument { get; set; } = "";
        public decimal Value { get; set; }
    }

    private List<ChartDataPoint> GetChartData()
    {
        if (RawReportData == null || !RawReportData.Any()) return new List<ChartDataPoint>();
        
        try
        {
            return RawReportData
                .Where(r => r.ContainsKey(Config.ChartXField) && r.ContainsKey(Config.ChartYField))
                .Take(20) // Limit chart data points
                .Select(r => new ChartDataPoint
                {
                    Argument = r[Config.ChartXField]?.ToString() ?? "",
                    Value = Convert.ToDecimal(r[Config.ChartYField] ?? 0)
                })
                .ToList();
        }
        catch
        {
            return new List<ChartDataPoint>();
        }
    }

    private async Task RefreshReport()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = string.Empty;
            StateHasChanged();

            var selectedQueueIds = SelectedQueues.ToList();
            var selectedColumns = SelectedColumns.ToList();

            if (!selectedQueueIds.Any())
            {
                ErrorMessage = "Please select at least one queue.";
                return;
            }

            if (!selectedColumns.Any())
            {
                ErrorMessage = "Please select at least one column.";
                return;
            }

            RawReportData = await ReportService.GetCustomReportDataAsync(
                Config.StartDate ?? DateTime.Today.AddDays(-7),
                Config.EndDate ?? DateTime.Today,
                selectedColumns,
                selectedQueueIds);

            // Convert Dictionary to ExpandoObject for DxGrid binding
            ReportData = RawReportData?.Select(dict =>
            {
                var expando = new ExpandoObject();
                var expandoDict = (IDictionary<string, object?>)expando;
                foreach (var kvp in dict)
                {
                    expandoDict[kvp.Key] = kvp.Value;
                }
                return expando;
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing report");
            ErrorMessage = $"Error loading report: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ExportReport(string format)
    {
        if (RawReportData == null || !RawReportData.Any()) return;

        try
        {
            IsExporting = true;
            StateHasChanged();

            byte[] fileBytes;
            string fileName;
            string mimeType;

            switch (format)
            {
                case "Excel":
                    fileBytes = await ExportService.ExportToExcelAsync(RawReportData, "Report");
                    fileName = $"Report_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
                    mimeType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                    break;
                case "CSV":
                    fileBytes = await ExportService.ExportToCsvAsync(RawReportData, "Report");
                    fileName = $"Report_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
                    mimeType = "text/csv";
                    break;
                case "PDF":
                    fileBytes = await ExportService.ExportToPdfAsync(RawReportData, "Report");
                    fileName = $"Report_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
                    mimeType = "application/pdf";
                    break;
                default:
                    return;
            }

            // Trigger file download via JS interop
            await DownloadFile(fileName, fileBytes, mimeType);
            Logger.LogInformation($"Exported {RawReportData.Count} rows to {format}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error exporting to {format}");
            ErrorMessage = $"Export failed: {ex.Message}";
        }
        finally
        {
            IsExporting = false;
            StateHasChanged();
        }
    }

    private async Task DownloadFile(string fileName, byte[] content, string mimeType)
    {
        var base64 = Convert.ToBase64String(content);
        await JS.InvokeVoidAsync("downloadFile", fileName, base64, mimeType);
    }
}
